<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Base reset and fonts */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 10;
      padding: 20px 30px;
      font-weight: 700;
      font-size: 28px;
      color: #764ba2;
      text-align: center;
      user-select: none;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-family: 'Poppins', sans-serif;
    }

    main {
      flex-grow: 1;
      padding: 30px 20px;
      max-width: 1200px; /* Increased max-width for better two-column layout */
      margin: 0 auto 60px;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      display: flex; /* Changed to flex */
      flex-direction: row; /* Changed to row for side-by-side sections */
      flex-wrap: wrap; /* Allows sections to wrap on smaller screens */
      gap: 30px; /* Adjusted gap for flex items */
      justify-content: center; /* Center items when they wrap */
      align-items: flex-start; /* Align items to the top */
    }

    h2, h3 {
      margin: 0 0 18px;
      font-weight: 700;
      color: #4a2c91;
    }

    /* Form inputs & textarea */
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 2px solid #ccc;
      font-size: 16px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Poppins', sans-serif;
      color: #444;
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 0 8px #764ba2aa;
      background: #fff7ff;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Buttons */
    button {
      background: #764ba2;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 14px 28px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.35s ease, transform 0.2s ease;
      box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
      font-family: 'Poppins', sans-serif;
    }
    button:hover {
      background: #5c3380;
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(92, 51, 128, 0.6);
    }
    button:active {
      transform: scale(0.98);
    }

    /* Sections */
    section {
      background: #f7f4fb;
      border-radius: 15px;
      padding: 24px 32px;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.15);
      max-height: 400px;
      overflow-y: auto;
      scroll-behavior: smooth;
      flex: 1 1 48%; /* Allows two columns with a small gap */
      min-width: 300px; /* Ensure sections don't get too small before wrapping */
      box-sizing: border-box; /* Ensures padding and border are included in the width */
    }
    /* Specific styling for the notice post section to ensure it always takes full width */
    .notice-post {
        flex: 1 1 100%; /* Make this section always take full width */
        max-height: none; /* Allow it to expand as needed */
        order: -1; /* Ensures it appears first */
    }


    /* Scrollbar styling */
    section::-webkit-scrollbar {
      width: 10px;
    }
    section::-webkit-scrollbar-track {
      background: #f0e9ff;
      border-radius: 10px;
    }
    section::-webkit-scrollbar-thumb {
      background: #764ba2;
      border-radius: 10px;
    }

    /* Cards */
    .notice-card,
    .feedback-card {
      background: #fff;
      border-radius: 12px;
      padding: 18px 24px;
      box-shadow: 0 2px 10px rgba(118, 75, 162, 0.1);
      margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.5s ease;
      opacity: 0;
      animation: fadeInUp 0.6s forwards;
      position: relative; /* For read/resolved indicator */
    }
    .notice-card:hover,
    .feedback-card:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(118, 75, 162, 0.3);
    }

    /* Animate fade in */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Buttons in cards */
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-edit, .btn-delete, .btn-mark-resolved {
      flex: 1 1 120px;
      padding: 10px 14px;
      font-weight: 700;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-edit {
      background: #28a745;
      color: white;
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    .btn-edit:hover {
      background: #1e7e34;
      transform: scale(1.05);
      box-shadow: 0 7px 22px rgba(30, 126, 52, 0.6);
    }
    .btn-delete {
      background: #dc3545;
      color: white;
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }
    .btn-delete:hover {
      background: #bd2130;
      transform: scale(1.05);
      box-shadow: 0 7px 22px rgba(189, 33, 48, 0.6);
    }
    .btn-mark-resolved {
        background: #007bff;
        color: white;
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    .btn-mark-resolved:hover {
        background: #0056b3;
        transform: scale(1.05);
        box-shadow: 0 7px 22px rgba(0, 86, 179, 0.6);
    }
    .resolved-feedback {
        opacity: 0.7;
        border-left: 5px solid #28a745;
    }
    .resolved-feedback::after {
        content: 'âœ“ Resolved';
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
    }

    /* Labels */
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #5c3a96;
    }

    /* Responsive */
    @media (max-width: 700px) {
      main {
        padding: 20px 12px;
        flex-direction: column; /* Stack vertically on small screens */
        gap: 36px; /* Restore original gap for vertical stacking */
      }
      section {
        max-height: 300px;
        padding: 18px 20px;
        flex: 1 1 100%; /* Take full width on small screens */
      }
      button, .btn-edit, .btn-delete, .btn-mark-resolved {
        flex: 1 1 100%;
      }
    }

    /* Scroll to top button */
    #scrollTopBtn {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #764ba2;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(118, 75, 162, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.3s ease;
      user-select: none;
      z-index: 50;
    }
    #scrollTopBtn:hover {
      background: #5c3380;
      transform: scale(1.15);
    }

    /* Search and Sort Controls */
    .controls-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
        align-items: flex-end;
    }
    .controls-group > div {
        flex: 1;
        min-width: 180px; /* Ensure inputs don't get too small */
    }
    .controls-group label {
        margin-bottom: 5px;
    }
    .controls-group input[type="text"],
    .controls-group select {
        margin-bottom: 0; /* Remove default margin */
        padding: 10px 14px; /* Adjust padding for control inputs */
    }
    .load-more-btn {
        display: block;
        width: fit-content;
        margin: 20px auto 0;
        padding: 12px 25px;
        background: #5c3a96;
        box-shadow: 0 5px 15px rgba(92, 58, 150, 0.4);
    }
    .load-more-btn:hover {
        background: #4a2c91;
        transform: scale(1.03);
        box-shadow: 0 7px 20px rgba(74, 44, 145, 0.6);
    }

    /* Notification styles */
    #notification-area {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .notification {
        background-color: #4a2c91; /* Default success */
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: 'Poppins', sans-serif;
        min-width: 250px;
        text-align: center;
        transform: translateX(100%);
    }
    .notification.success {
        background-color: #28a745;
    }
    .notification.error {
        background-color: #dc3545;
    }
    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }
  </style>
</head>
<body>
  <header>Admin Dashboard</header>

  <main>
    <section class="notice-post" aria-label="Post Notice Section">
      <h3>Post Notice</h3>
      <label for="notice-title">Notice Title</label>
      <input type="text" id="notice-title" placeholder="Enter Notice Title" aria-required="true" />

      <label for="notice-content">Notice Content</label>
      <textarea id="notice-content" placeholder="Enter Notice Content" aria-required="true"></textarea>

      <button onclick="postNotice()" aria-label="Post Notice">Post Notice</button>
    </section>

    <section class="manage-notices" aria-label="Manage Notices Section">
      <h3>Manage Notices</h3>
      <div class="controls-group">
        <div>
            <label for="notice-search">Search Notices</label>
            <input type="text" id="notice-search" placeholder="Search by title or content" onkeyup="filterNotices()" />
        </div>
        <div>
            <label for="notice-sort">Sort Notices By</label>
            <select id="notice-sort" onchange="sortNotices()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
            </select>
        </div>
      </div>
      <div id="noticeContainer" aria-live="polite" aria-busy="true">Loading notices...</div>
      <button id="loadMoreNoticesBtn" class="load-more-btn" style="display: none;" onclick="loadMoreNotices()">Load More Notices</button>
    </section>

    <section class="feedback-list" aria-label="Manage Feedback and Complaints Section">
      <h3>Manage Feedback & Complaints</h3>
      <div class="controls-group">
        <div>
            <label for="feedback-search">Search Feedback</label>
            <input type="text" id="feedback-search" placeholder="Search by subject or message" onkeyup="filterFeedbacks()" />
        </div>
        <div>
            <label for="feedback-priority-filter">Filter by Priority</label>
            <select id="feedback-priority-filter" onchange="filterFeedbacks()">
                <option value="All">All Priorities</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div>
            <label for="feedback-sort">Sort Feedback By</label>
            <select id="feedback-sort" onchange="sortFeedbacks()">
                <option value="newest">Newest First</option>
                <option value="upvotes">Most Upvoted</option>
                <option value="priority">Priority (High to Low)</option>
            </select>
        </div>
      </div>
      <div id="feedbackContainer" aria-live="polite" aria-busy="true">Loading feedbacks...</div>
      <button id="loadMoreFeedbacksBtn" class="load-more-btn" style="display: none;" onclick="loadMoreFeedbacks()">Load More Feedback</button>
    </section>
  </main>

  <button id="scrollTopBtn" onclick="scrollToTop()" title="Scroll to top" aria-label="Scroll to top">&#8679;</button>

  <!-- Notification Area -->
  <div id="notification-area"></div>

  <script>
    // Scroll to top button functionality
    const scrollBtn = document.getElementById('scrollTopBtn');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        scrollBtn.style.display = 'flex';
      } else {
        scrollBtn.style.display = 'none';
      }
    });
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    

    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    // Store fetched data globally for filtering/sorting
    let allNotices = [];
    let allFeedbacks = [];
    const NOTICES_PER_LOAD = 5; // Number of notices to load at once
    const FEEDBACKS_PER_LOAD = 5; // Number of feedbacks to load at once
    let currentNoticeDisplayCount = 0;
    let currentFeedbackDisplayCount = 0;


    if (!token || role !== 'admin') {
      window.location.href = 'login.html';
    }

    // --- Notification Function ---
    function showNotification(message, type = 'success') {
      const notificationArea = document.getElementById('notification-area');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notificationArea.prepend(notification); // Add to top

      setTimeout(() => notification.classList.add('show'), 10);

      setTimeout(() => {
        notification.classList.remove('show');
        notification.addEventListener('transitionend', () => notification.remove(), { once: true });
      }, 3000);
    }

    // --- Notice Management ---
    async function fetchNotices() {
      try {
        const res = await fetch('/notices', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();

        const container = document.getElementById('noticeContainer');
        container.setAttribute('aria-busy', 'false');
        if (!data.success) {
          container.innerHTML = `<p style="color:red;">Failed to load notices: ${data.message || 'Unknown error'}</p>`;
          showNotification(`Failed to load notices: ${data.message || 'Unknown error'}`, 'error');
          return;
        }

        allNotices = data.notices.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Default sort by newest
        currentNoticeDisplayCount = 0; // Reset count
        displayNotices();

      } catch (error) {
        const container = document.getElementById('noticeContainer');
        container.innerHTML = `<p style="color:red;">Server error fetching notices.</p>`;
        showNotification('Server error fetching notices.', 'error');
      }
    }

    function displayNotices() {
        const container = document.getElementById('noticeContainer');
        container.innerHTML = ''; // Clear existing notices for re-render
        const loadMoreBtn = document.getElementById('loadMoreNoticesBtn');

        const filtered = applyNoticeFilters(allNotices);
        const sorted = applyNoticeSorting(filtered);

        // Calculate how many more items to display
        const itemsToLoad = NOTICES_PER_LOAD;
        const endIndex = currentNoticeDisplayCount + itemsToLoad;
        const itemsToDisplay = sorted.slice(0, endIndex);
        currentNoticeDisplayCount = itemsToDisplay.length;


        if (itemsToDisplay.length === 0 && sorted.length === 0) { // No items at all
            container.innerHTML = '<p>No notices found.</p>';
            loadMoreBtn.style.display = 'none';
            return;
        } else if (itemsToDisplay.length === 0 && sorted.length > 0) { // No items matching filter
             container.innerHTML = '<p>No notices found matching your search/filter criteria.</p>';
             loadMoreBtn.style.display = 'none';
             return;
        }


        itemsToDisplay.forEach(notice => {
            const card = document.createElement('div');
            card.className = 'notice-card';
            card.style.animationDelay = `${Math.random() * 0.3}s`;
            card.innerHTML = `
                <label for="title-${notice.id}"><strong>Title:</strong></label>
                <input type="text" id="title-${notice.id}" value="${escapeHtml(notice.title)}" />

                <label for="content-${notice.id}"><strong>Content:</strong></label>
                <textarea id="content-${notice.id}" rows="3">${escapeHtml(notice.content)}</textarea>

                <div class="button-group">
                <button class="btn-edit" onclick="updateNotice(${notice.id})">Update</button>
                <button class="btn-delete" onclick="deleteNotice(${notice.id})">Delete</button>
                </div>
            `;
            container.appendChild(card);
        });

        if (currentNoticeDisplayCount < sorted.length) {
            loadMoreBtn.style.display = 'block';
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    function loadMoreNotices() {
        displayNotices(); // Calling displayNotices again will load the next batch
    }

    function applyNoticeFilters(notices) {
        const searchTerm = document.getElementById('notice-search').value.toLowerCase();
        if (!searchTerm) return notices;
        return notices.filter(notice =>
            (notice.title && notice.title.toLowerCase().includes(searchTerm)) || // Added null check
            (notice.content && notice.content.toLowerCase().includes(searchTerm)) // Added null check
        );
    }

    function applyNoticeSorting(notices) {
        const sortBy = document.getElementById('notice-sort').value;
        if (sortBy === 'newest') {
            return [...notices].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortBy === 'oldest') {
            return [...notices].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        }
        return notices; // Should not happen with current options
    }

    function filterNotices() {
        currentNoticeDisplayCount = 0; // Reset count for new filter
        displayNotices();
    }

    function sortNotices() {
        currentNoticeDisplayCount = 0; // Reset count for new sort
        displayNotices();
    }


    async function updateNotice(id) {
      const title = document.getElementById(`title-${id}`).value.trim();
      const content = document.getElementById(`content-${id}`).value.trim();

      if (!title || !content) {
        showNotification('Title and Content cannot be empty.', 'error');
        return;
      }

      try {
        const res = await fetch(`/notices/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token,
          },
          body: JSON.stringify({ title, content }),
        });
        const data = await res.json();

        if (data.success) {
          showNotification('Notice updated successfully.', 'success');
          fetchNotices(); // Re-fetch to update local data and re-render
        } else {
          showNotification('Update failed: ' + (data.message || 'Unknown error'), 'error');
        }
      } catch (err) {
        showNotification('Server error while updating notice.', 'error');
      }
    }

    async function deleteNotice(id) {
      // Replaced confirm() with a custom message box for better UX in a Canvas environment
      if (!await showConfirmDialog('Are you sure you want to delete this notice?')) return;

      try {
        const res = await fetch(`/notices/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token },
        });
        const data = await res.json();

        if (data.success) {
          showNotification('Notice deleted successfully.', 'success');
          fetchNotices(); // Re-fetch to update local data and re-render
        } else {
          showNotification('Delete failed: ' + (data.message || 'Unknown error'), 'error');
        }
      } catch (err) {
        showNotification('Server error while deleting notice.', 'error');
      }
    }

    async function postNotice() {
      const title = document.getElementById('notice-title').value.trim();
      const content = document.getElementById('notice-content').value.trim();

      if (!title || !content) {
        showNotification('Title and Content are required.', 'error');
        return;
      }

      try {
        const res = await fetch('/notices', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token,
          },
          body: JSON.stringify({ title, content }),
        });
        const data = await res.json();

        if (data.success) {
          showNotification('Notice posted!', 'success');
          document.getElementById('notice-title').value = '';
          document.getElementById('notice-content').value = '';
          fetchNotices(); // Re-fetch to update local data and re-render
        } else {
          showNotification('Failed to post notice: ' + (data.message || 'Unknown error'), 'error');
        }
      } catch (err) {
        showNotification('Server error while posting notice.', 'error');
      }
    }

    // --- Feedback Management ---
    async function fetchFeedbacks()  {
        try {
            const res = await fetch('/feedback', {
                headers: { Authorization: 'Bearer ' + token },
            });
            const data = await res.json();

            const container = document.getElementById('feedbackContainer');
            container.setAttribute('aria-busy', 'false');
            if (!data.success) {
                container.innerHTML = `<p style="color:red;">Failed to load feedbacks: ${data.message || 'Unknown error'}</p>`;
                showNotification(`Failed to load feedbacks: ${data.message || 'Unknown error'}`, 'error');
                return;
            }

            allFeedbacks = data.feedbacks.map(fb => ({...fb, isResolved: false})).sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Default sort by newest, add isResolved for client-side
            currentFeedbackDisplayCount = 0; // Reset count
            displayFeedbacks();

        } catch (error) {
            const container = document.getElementById('feedbackContainer');
            container.innerHTML = `<p style="color:red;">Server error fetching feedbacks.</p>`;
            showNotification('Server error fetching feedbacks.', 'error');
        }
    }

    function displayFeedbacks() {
        const container = document.getElementById('feedbackContainer');
        container.innerHTML = ''; // Clear existing feedbacks for re-render
        const loadMoreBtn = document.getElementById('loadMoreFeedbacksBtn');

        const filtered = applyFeedbackFilters(allFeedbacks);
        const sorted = applyFeedbackSorting(filtered);

        // Calculate how many more items to display
        const itemsToLoad = FEEDBACKS_PER_LOAD;
        const endIndex = currentFeedbackDisplayCount + itemsToLoad;
        const itemsToDisplay = sorted.slice(0, endIndex);
        currentFeedbackDisplayCount = itemsToDisplay.length;


        if (itemsToDisplay.length === 0 && sorted.length === 0) { // No items at all
            container.innerHTML = '<p>No feedbacks available.</p>';
            loadMoreBtn.style.display = 'none';
            return;
        } else if (itemsToDisplay.length === 0 && sorted.length > 0) { // No items matching filter
             container.innerHTML = '<p>No feedbacks found matching your search/filter criteria.</p>';
             loadMoreBtn.style.display = 'none';
             return;
        }


        itemsToDisplay.forEach(fb => {
            const card = document.createElement('div');
            card.className = `feedback-card ${fb.isResolved ? 'resolved-feedback' : ''}`;
            card.dataset.id = fb.id; // Store ID for easy lookup
            card.style.animationDelay = `${Math.random() * 0.3}s`;
            card.innerHTML = `
                <label for="subject-${fb.id}"><strong>Subject:</strong></label>
                <input type="text" id="subject-${fb.id}" value="${escapeHtml(fb.subject || '')}" />

                <label for="message-${fb.id}"><strong>Message:</strong></label>
                <textarea id="message-${fb.id}" rows="3">${escapeHtml(fb.message)}</textarea>

                <label for="priority-${fb.id}"><strong>Priority:</strong></label>
                <select id="priority-${fb.id}">
                <option value="Low" ${fb.priority === 'Low' ? 'selected' : ''}>Low</option>
                <option value="Medium" ${fb.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                <option value="High" ${fb.priority === 'High' ? 'selected' : ''}>High</option>
                </select>

                <p><strong>Submitted By:</strong> ${escapeHtml(fb.user_name || 'Unknown')}</p>
                <p><strong>Upvotes:</strong> ${fb.upvotes_count || 0}</p>

                <div class="button-group">
                <button class="btn-edit" onclick="updateFeedback(${fb.id})">Update</button>
                <button class="btn-delete" onclick="deleteFeedback(${fb.id})">Delete</button>
                <button class="btn-mark-resolved" onclick="toggleFeedbackResolved(${fb.id})">
                    ${fb.isResolved ? 'Mark Unresolved' : 'Mark Resolved'}
                </button>
                </div>
            `;
            container.appendChild(card);
        });

        if (currentFeedbackDisplayCount < sorted.length) {
            loadMoreBtn.style.display = 'block';
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    function loadMoreFeedbacks() {
        displayFeedbacks(); // Calling displayFeedbacks again will load the next batch
    }

    function applyFeedbackFilters(feedbacks) {
        let filtered = feedbacks;

        const searchTerm = document.getElementById('feedback-search').value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(fb =>
                (fb.subject && fb.subject.toLowerCase().includes(searchTerm)) ||
                (fb.message && fb.message.toLowerCase().includes(searchTerm))
            );
        }

        const priorityFilter = document.getElementById('feedback-priority-filter').value;
        if (priorityFilter !== 'All') {
            filtered = filtered.filter(fb => fb.priority === priorityFilter);
        }

        return filtered;
    }

    function applyFeedbackSorting(feedbacks) {
        const sortBy = document.getElementById('feedback-sort').value;
        if (sortBy === 'newest') {
            return [...feedbacks].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortBy === 'upvotes') {
            return [...feedbacks].sort((a, b) => (b.upvotes_count || 0) - (a.upvotes_count || 0));
        } else if (sortBy === 'priority') {
            const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
            return [...feedbacks].sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
        }
        return feedbacks;
    }

    function filterFeedbacks() {
        currentFeedbackDisplayCount = 0; // Reset count for new filter
        displayFeedbacks();
    }

    function sortFeedbacks() {
        currentFeedbackDisplayCount = 0; // Reset count for new sort
        displayFeedbacks();
    }

    function toggleFeedbackResolved(id) {
        const feedbackIndex = allFeedbacks.findIndex(fb => fb.id === id);
        if (feedbackIndex > -1) {
            allFeedbacks[feedbackIndex].isResolved = !allFeedbacks[feedbackIndex].isResolved;
            displayFeedbacks(); // Re-render to show visual change
            showNotification(`Feedback ${id} marked as ${allFeedbacks[feedbackIndex].isResolved ? 'Resolved' : 'Unresolved'}.`, 'info');
            // In a real application, you'd send an API call here to update the 'resolved' status on the backend.
            // For now, it's a client-side only visual toggle.
        }
    }

    async function updateFeedback(id) {
      const subject = document.getElementById(`subject-${id}`).value.trim();
      const message = document.getElementById(`message-${id}`).value.trim();
      const priority = document.getElementById(`priority-${id}`).value;

      if (!message) {
        showNotification('Message cannot be empty.', 'error');
        return;
      }

      try {
        const res = await fetch(`/feedback/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token,
          },
          body: JSON.stringify({ subject, message, priority }),
        });
        const data = await res.json();

        if (data.success) {
          showNotification('Feedback updated successfully.', 'success');
          fetchFeedbacks(); // Re-fetch to update local data and re-render
        } else {
          showNotification('Update failed: ' + (data.message || 'Unknown error'), 'error');
        }
      } catch (err) {
        showNotification('Server error while updating feedback.', 'error');
      }
    }

    async function deleteFeedback(id) {
      // Replaced confirm() with a custom message box for better UX in a Canvas environment
      if (!await showConfirmDialog('Are you sure you want to delete this feedback?')) return;

      try {
        const res = await fetch(`/feedback/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token },
        });
        const data = await res.json();

        if (data.success) {
          showNotification('Feedback deleted successfully.', 'success');
          fetchFeedbacks(); // Re-fetch to update local data and re-render
        } else {
          showNotification('Delete failed: ' + (data.message || 'Unknown error'), 'error');
        }
      } catch (err) {
        showNotification('Server error while deleting feedback.', 'error');
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- Custom Confirmation Dialog (replaces window.confirm) ---
    function showConfirmDialog(message) {
        return new Promise(resolve => {
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1001;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            `;

            const dialogBox = document.createElement('div');
            dialogBox.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 400px;
                font-family: 'Poppins', sans-serif;
                color: #333;
                transform: translateY(-20px);
                transition: transform 0.3s ease-in-out;
            `;

            const messagePara = document.createElement('p');
            messagePara.textContent = message;
            messagePara.style.marginBottom = '25px';
            messagePara.style.fontSize = '1.1em';
            messagePara.style.fontWeight = '600';
            messagePara.style.color = '#4a2c91';

            const buttonGroup = document.createElement('div');
            buttonGroup.style.display = 'flex';
            buttonGroup.style.gap = '15px';
            buttonGroup.style.justifyContent = 'center';

            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Yes, Delete';
            confirmBtn.className = 'btn-delete'; // Reuse delete button style
            confirmBtn.style.flex = '1';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn-edit'; // Reuse edit button style for cancel
            cancelBtn.style.flex = '1';
            cancelBtn.style.backgroundColor = '#6c757d'; // A neutral color
            cancelBtn.style.boxShadow = '0 5px 15px rgba(108, 117, 125, 0.3)';

            confirmBtn.onclick = () => {
                dialogOverlay.style.opacity = '0';
                dialogBox.style.transform = 'translateY(-20px)';
                dialogOverlay.addEventListener('transitionend', () => dialogOverlay.remove(), { once: true });
                resolve(true);
            };

            cancelBtn.onclick = () => {
                dialogOverlay.style.opacity = '0';
                dialogBox.style.transform = 'translateY(-20px)';
                dialogOverlay.addEventListener('transitionend', () => dialogOverlay.remove(), { once: true });
                resolve(false);
            };

            buttonGroup.appendChild(cancelBtn);
            buttonGroup.appendChild(confirmBtn);
            dialogBox.appendChild(messagePara);
            dialogBox.appendChild(buttonGroup);
            dialogOverlay.appendChild(dialogBox);
            document.body.appendChild(dialogOverlay);

            // Animate in
            setTimeout(() => {
                dialogOverlay.style.opacity = '1';
                dialogBox.style.transform = 'translateY(0)';
            }, 10);
        });
    }


    // Initial load
    fetchNotices();
    fetchFeedbacks();
  </script>
</body>
</html>
